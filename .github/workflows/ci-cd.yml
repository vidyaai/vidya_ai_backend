name: prod CI/CD
on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Service containers to run with `runner-job`
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit==4.3.0
      - name: Run Static Checks
        uses: pre-commit/action@v3.0.0
      - name: SSH into ec2 and execute commands
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.PROD_KEY }}
          script: |
            sudo systemctl stop vidyaai_backend_gunicorn
            sudo rm -r venv
            sudo rm -r vidya_ai_backend
            git clone https://github.com/vidyaai/vidya_ai_backend.git
            python3.13 -m venv venv
            source venv/bin/activate
            cd vidya_ai_backend
            pip install --upgrade pip
            pip install -r requirements.txt
            pip uninstall -y opencv-python-headless==4.12.0.88
            pip install opencv-python-headless==4.12.0.88
            pip install gunicorn
            touch src/${{ secrets.FIREBASE_CONFIG }}
            cat <<EOF >src/${{ secrets.FIREBASE_CONFIG }}
            ${{ secrets.FIREBASE_CONFIG_CONTENT }}
            EOF
            cat <<EOF >${{ secrets.GOOGLE_CLOUD_CREDENTIALS_FILE }}
            ${{ secrets.GOOGLE_CLOUD_CREDENTIALS_FILE_CONTENT }}
            EOF
            touch .env
            cat <<EOF >.env
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_S3_REGION=${{ secrets.AWS_S3_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            FIREBASE_CONFIG=${{ secrets.FIREBASE_CONFIG }}
            GOOGLE_CLOUD_CREDENTIALS_FILE=${{ secrets.GOOGLE_CLOUD_CREDENTIALS_FILE }}
            DEEPGRAM_API_KEY=${{ secrets.DEEPGRAM_API_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            STRIPE_PLUS_MONTHLY_PRICE_ID=${{ secrets.STRIPE_PLUS_MONTHLY_PRICE_ID }}
            STRIPE_PLUS_ANNUAL_PRICE_ID=${{ secrets.STRIPE_PLUS_ANNUAL_PRICE_ID }}
            STRIPE_PRO_MONTHLY_PRICE_ID=${{ secrets.STRIPE_PRO_MONTHLY_PRICE_ID }}
            STRIPE_PRO_ANNUAL_PRICE_ID=${{ secrets.STRIPE_PRO_ANNUAL_PRICE_ID }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}

            DIAGRAM_YOLO_MODEL_PATH=${{ secrets.DIAGRAM_YOLO_MODEL_PATH }}
            POPPLER_PATH=/usr/bin/

            TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
            GOOGLE_CSE_API_KEY=${{ secrets.GOOGLE_CSE_API_KEY }}
            GOOGLE_CSE_ID=${{ secrets.GOOGLE_CSE_ID }}
            EOF
            alembic upgrade head
            sudo systemctl start vidyaai_backend_gunicorn